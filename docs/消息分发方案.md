# Why - 为什么需要消息分发？

- MDA是面向分布式的系统

  需要能够支持每个环节的横向扩展能力，即需要支持消息分区和并行处理。

- 需要控制消息流向。

  有的业务需要保障消息的顺序性，那么就需要控制消息的流向。

# What - 有哪些消息？

MDA是一个消息驱动的系统，一共存在以下几种类型的消息：

- **应用层命令 - ApplicationCommand**

  UI通过调用应用层命令服务直接发出的命令，一个应用层命令，就是一条业务流程，比如：汇款、存款、转账。

- **领域层命令 - DomainCommand**

  在MDA世界里，业务对象具有主观能动性，即自己主动接受消息，处理消息，发送消息，可以理解为业务对象是活的，就像人一样，你跟他聊天就行了，而不是死板地调用它，这种模式称为面向响应式的领域驱动设计(DDD)。

  为了实现此目标，故而引入了领域命令的概念，将以前通过调用对象方法来触发业务处理的方式，转化成发送领域命令。

- **领域层事件 - DomainEvent**

  业务对象处理领域命令后，就会发送领域事件，然后通过应用领域事件来修改业务对象的状态。

  不仅如此，当业务对象从失活状态恢复时，也会通过应用领域事件来恢复状态。

  > 备注：可以将领域事件看做是业务对象的变更日志(Change Log)。

- **应用层通知 - ApplicationNotification**

当一个业务涉及到多个聚合根的多个业务处理时，就需要通过发送应用层的通知来协接业务，最终完成整个业务流程。

比如：转账业务，首先需要从源账户扣款，然后才能存款到目标账户。

# How - 消息如何分发？

## 消息分区

根据分区键，按照分区规则策略进行分区。

### 分区策略

- **全局**

  这种情况下，一般只有一个命令处理器，规则为永远将消息分发给第一个处理器。

- **随机**

  将消息随机分发给处理器。

- **负载均衡**

  将消息均衡地分配给处理器。

- **广播**

  将消息发送给所有处理器。

- **转发**

  将消息按照规则直接转发给指定处理器。

- **自定义**

  当以上策略都不满足时，允许使用者扩展自己的分区策略。

## 分发规则

### 1. 如何分发应用层命令？

应用层命令都是无状态的，如何快速地将命令发送给应用命令处理器才是最关心的问题。

对于小型项目而言，这一层可能不想做成分布式，即不需要多个命令处理器来并行处理命令，这种情况下采用全局分发策略。

对于大型的分布式系统，这一层需要支持多个命令处理器来实现并行处理，这种情况下系统默认采用随机分发策略。

### 2. 如何分发领域层命令？

当一个应用层命令，只产生一个领域层命令时，分发逻辑与应用层命令一致。

当一个应用层命令，产生多个领域层命令时，需要保障消息的有序性，这种情况下，系统约定同一个应用层命令产生的命令必须分发给同一分区。

### 3. 如何分发领域层事件？



### 4. 如何分发应用层通知？